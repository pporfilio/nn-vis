<html>
<head>

    <title>NN Vis</title>

    <script src="https://d3js.org/d3.v5.min.js"></script> 
    <script type="text/javascript" src="javascript/neuralNetwork.js"></script>
    <script type="text/javascript" src="javascript/neuralNetworkView.js"></script>
    <script type="text/javascript" src="vendor/js-signals/dist/signals.min.js"></script>

    <script>
        function start() {
            load_json();
        }

        function load_json() {
            // From https://stackoverflow.com/questions/14388452/how-do-i-load-a-json-object-from-a-file-with-ajax
            function fetchJSONFile(path, callback) {
                var httpRequest = new XMLHttpRequest();
                httpRequest.onreadystatechange = function() {
                    console.log("httpRequest.readyState: " + httpRequest.readyState);
                    console.log("httpRequest.status: " + httpRequest.status);
                    if (httpRequest.readyState === 4) {
                        if (httpRequest.status === 200) {
                            var data = JSON.parse(httpRequest.responseText);
                            if (callback) callback(data);
                        }
                    }
                };
                httpRequest.open('GET', path);
                httpRequest.send(); 
            }

            // This requests the file and executes a callback with the parsed result once
            //   it is available
            fetchJSONFile('https://s3.amazonaws.com/pporfilio/nn/test_json.json', 
                function(data){
                    populate(data)
                }
            );
        }

        function populate(data) {
            var selectLayerEl = document.getElementById("selectLayer"); 
            var selectNodeEl = document.getElementById("selectNode");
            var nn = new NeuralNetwork(data);

            selectLayerEl.addEventListener("change", function() {
                onSelectLayerChanged(nn, this, selectNodeEl);
            });

            selectNodeEl.addEventListener("change", function() {
                onSelectNodeChanged(nn, selectLayerEl, this);
            });

            for(var i = 0; i < nn.getLayerCount(); ++i) {
                var optionEl = document.createElement("option");
                optionEl.textContent = "layer " + i + " (" + nn.getNodeCountInLayer(i) + " nodes)";
                optionEl.value = nn.getNodeCountInLayer(i);
                selectLayerEl.appendChild(optionEl);
            }

            // Don't seem to get a changed callback after repopulating the layer dropdown.
            onSelectLayerChanged(nn, selectLayerEl, selectNodeEl);

            initialize_d3(nn);
        }

        function initialize_d3(neuralNetwork) {
            var d3svgEl = d3.select("#d3svg")

            var nnView = new NeuralNetworkView(neuralNetwork, d3svgEl);
        }


        function onSelectLayerChanged(neuralNetwork, selectLayerEl, selectNodeEl) {
            console.log("got selected index: " + selectLayerEl.selectedIndex);
            for (var i = selectNodeEl.options.length - 1; i >= 0; --i) {
                selectNodeEl.remove(i);
            }
            for (var i = 0; i < selectLayerEl.value; ++i) {
                var optionEl = document.createElement("option");
                optionEl.textContent = "Node " + i;
                optionEl.value = i;
                selectNodeEl.appendChild(optionEl);
            }

            // Don't seem to get changed callback after repopulating the node dropdown.
            onSelectNodeChanged(neuralNetwork, selectLayerEl, selectNodeEl);
        }

        function onSelectNodeChanged(neuralNetwork, selectLayerEl, selectNodeEl) {
            console.log("got selected node: " + selectNodeEl.selectedIndex);
            var biasTextAreaEl = document.getElementById("biasTextArea");
            var inputWeightTextAreaEl = document.getElementById("inputWeightTextArea");
            if (selectLayerEl.selectedIndex <= 0) {
                biasTextAreaEl.value = "--";
                inputWeightTextAreaEl.value = "--";
            } else {
                var selectedNode = neuralNetwork.getNodeAt(selectLayerEl.selectedIndex, selectNodeEl.selectedIndex);
                biasTextAreaEl.value = neuralNetwork.getBiasForNode(selectedNode);
                inputWeightTextAreaEl.value = neuralNetwork.getInputWeightsForNode(selectedNode).join("\n");
            }
        }
    </script>
</head>

<body onload="start()">
    Select a Layer: <select id="selectLayer"></select>
    <br />
    Select a Node: <select id="selectNode"></select>
    <br />
    Bias
    <br />
    <textarea id="biasTextArea" rows="1" cols = "20" readonly="true"></textarea>
    <br />
    Input Weights
    <br />
    <textarea id="inputWeightTextArea" rows="20" cols="20" readonly="true"></textarea>
    <br />
    <svg id="d3svg" width="600" height="300"></svg>
</body>
</html>
