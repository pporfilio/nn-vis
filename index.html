<html>
<head>

    <title>NN Vis</title>

    <script src="https://d3js.org/d3.v5.min.js"></script> 

    <script>
        function start() {
            load_json();
        }

        function load_json() {
            // From https://stackoverflow.com/questions/14388452/how-do-i-load-a-json-object-from-a-file-with-ajax
            function fetchJSONFile(path, callback) {
                var httpRequest = new XMLHttpRequest();
                httpRequest.onreadystatechange = function() {
                    console.log("httpRequest.readyState: " + httpRequest.readyState);
                    console.log("httpRequest.status: " + httpRequest.status);
                    if (httpRequest.readyState === 4) {
                        if (httpRequest.status === 200) {
                            var data = JSON.parse(httpRequest.responseText);
                            if (callback) callback(data);
                        }
                    }
                };
                httpRequest.open('GET', path);
                httpRequest.send(); 
            }

            // This requests the file and executes a callback with the parsed result once
            //   it is available
            fetchJSONFile('https://s3.amazonaws.com/pporfilio/nn/test_json.json', 
                function(data){
                    populate(data)
                }
            );
        }

        function populate(data) {
            var selectLayerEl = document.getElementById("selectLayer"); 
            var selectNodeEl = document.getElementById("selectNode");

            selectLayerEl.addEventListener("change", function() {
                onSelectLayerChanged(data, this, selectNodeEl);
            });

            selectNodeEl.addEventListener("change", function() {
                onSelectNodeChanged(data, selectLayerEl, this);
            });

            for(var i = 0; i < data.layers.length; ++i) {
                var optionEl = document.createElement("option");
                optionEl.textContent = "layer " + i + " (" + data.layers[i] + " nodes)";
                optionEl.value = data.layers[i];
                selectLayerEl.appendChild(optionEl);
            }

            // Don't seem to get a changed callback after repopulating the layer dropdown.
            onSelectLayerChanged(data, selectLayerEl, selectNodeEl);

            initialize_d3(data);
        }

        function initialize_d3(data) {
            var d3svgEl = d3.select("#d3svg")
            var nodes = [];
            for (var layerIndex = 0; layerIndex < data.layers.length; ++layerIndex) {
                for (var nodeIndex = 0; nodeIndex < data.layers[layerIndex]; ++nodeIndex) {
                    nodes.push({
                        layerIndex: layerIndex,
                        nodeIndex: nodeIndex,
                        data: data
                    })
                }
            }

            var globalGroup = d3svgEl.append("g");

            globalGroup.selectAll("circle .nodes")
            .data(nodes, function(node) { return node.layerIndex + "," + node.nodeIndex; })
            .enter()
            .append("svg:circle")
            .attr("class", "nodes")
            .attr("cx", function(node) { return 10 + node.layerIndex * 50; })
            .attr("cy", function(node) { return 10 + node.nodeIndex * 25; })
            .attr("r", "10px")
            .attr("fill", "black")

            d3svgEl.append("rect")
            .attr("width", d3svgEl.attr("width"))
            .attr("height", d3svgEl.attr("height"))
            .style("fill", "none")
            .style("pointer-events", "all")
            .style("stroke", "black")
            .style("stroke-width", "2")
            .call(d3.zoom()
                .scaleExtent([1 / 2, 4])
                .on("zoom", function() { onZoom(globalGroup); }));
        }

        function onZoom(group) {
            group.attr("transform", d3.event.transform);
        }


        function onSelectLayerChanged(data, selectLayerEl, selectNodeEl) {
            console.log("got selected index: " + selectLayerEl.selectedIndex);
            for (var i = selectNodeEl.options.length - 1; i >= 0; --i) {
                selectNodeEl.remove(i);
            }
            for (var i = 0; i < selectLayerEl.value; ++i) {
                var optionEl = document.createElement("option");
                optionEl.textContent = "Node " + i;
                optionEl.value = i;
                selectNodeEl.appendChild(optionEl);
            }

            // Don't seem to get changed callback after repopulating the node dropdown.
            onSelectNodeChanged(data, selectLayerEl, selectNodeEl);
        }

        function onSelectNodeChanged(data, selectLayerEl, selectNodeEl) {
            console.log("got selected node: " + selectNodeEl.selectedIndex);
            var biasTextAreaEl = document.getElementById("biasTextArea");
            var inputWeightTextAreaEl = document.getElementById("inputWeightTextArea");
            if (selectLayerEl.selectedIndex <= 0) {
                biasTextAreaEl.value = "--";
                inputWeightTextAreaEl.value = "--";
            } else {
                biasTextAreaEl.value = data.biases[selectLayerEl.selectedIndex][selectNodeEl.selectedIndex];
                console.log(data.weights[selectLayerEl.selectedIndex]);
                console.log(data.weights[selectLayerEl.selectedIndex][selectNodeEl.selectedIndex]);
                inputWeightTextAreaEl.value = data.weights[selectLayerEl.selectedIndex][selectNodeEl.selectedIndex].join("\n");
            }
        }

    </script>
</head>

<body onload="start()">
    Select a Layer: <select id="selectLayer"></select>
    <br />
    Select a Node: <select id="selectNode"></select>
    <br />
    Bias
    <br />
    <textarea id="biasTextArea" rows="1" cols = "20" readonly="true"></textarea>
    <br />
    Input Weights
    <br />
    <textarea id="inputWeightTextArea" rows="20" cols="20" readonly="true"></textarea>
    <br />
    <svg id="d3svg" width="600" height="300"></svg>
</body>
</html>
